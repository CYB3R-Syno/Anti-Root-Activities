# CVE-2014-6271 / Shellshock
작성자 : Syno 

사실상 해당 글은 하단에 참고 글에 적혀있는 **홈페이지 취약점 분석 이야기** 라는 사이트 안에 적혀있던 글에서 굉장히 많은 도움을 받았다.

그저 직접 실습해보고 알아가보는 시간을 가질려던 생각에 비하면 굉장히 많은 도움을 받은 부분에 대해서 감사하다는 마음을 표현합니다 :)

해당 취약점은 2014년 9월 24일에 공개되어 "CVE-2014-6271"로 지정된 이후 유사한 취약점들이 GNU Bash에서 추가로 발견되었습니다.

Shellshock 취약점에 경우 CGI 기반 웹서버나 DHCP 클라이언트, IBM HMC restricted shell 등 다양한 환경에서에 공격이 가능하다.

이처럼 취약한 Bash는 반드시 업데이트를 해줘야한다.

<hr>

참고 글 

[홈페이지 취약점 분석 이야기](https://webhack.dynu.net/?idx=20161104.001)    
[PentesterLab CVE-2014-6271/Shellshock 훈련장](https://pentesterlab.com/exercises/cve-2014-6271/course)   
[WikiPedia/Shellshock](https://ko.wikipedia.org/wiki/셸쇼크)

<hr>

## PentesterLab CVE-2014-6271/Shellshock 훈련장 설치 과정
PentesterLab의 CVE-2014-6271/Shellshock 훈련장에서 해당 CVE 취약점에 ISO 파일을 다운받는다.

[VMware Fusion 기준]

+ -> New -> Continue -> cve-2014-6271.iso 선택 후 Continue -> Linux (Other Linux) 
<img width="832" alt="Screen Shot 2021-12-24 at 7 56 43 PM" src="https://user-images.githubusercontent.com/84657474/147346983-4fbe95ab-80f5-4929-aaee-26a94a088950.png">
위와 같은 순서로 진행 시 해당 사진과 같이 CVE 훈련장이 부팅되고 있는 화면을 볼 수 있다.

<img width="832" alt="Screen Shot 2021-12-24 at 7 59 35 PM" src="https://user-images.githubusercontent.com/84657474/147347188-c75d7a02-7115-431f-a9bb-7c8147786303.png">
이 후 부팅이 끝났다면 ```ifconfig``` 명령어를 통하여 ip주소를 확인한 후 인터넷을 통하여 접속해주면 된다.

<img width="1792" alt="Screen Shot 2021-12-24 at 8 00 19 PM" src="https://user-images.githubusercontent.com/84657474/147347249-8bf6c313-3289-42ca-ae1f-b99f1bbdd803.png">
접속을 하면 다음과 같이 CVE-2014-6271 이라는 글자가 반겨주는 걸 볼 수 있다.

<hr>

## Nmap을 통한 네트워크 포트 확인하기
Nmap을 통하여 Shellshock 가상머신에서 열려있는 포트를 확인한다.
<img width="1792" alt="Screen Shot 2021-12-24 at 8 04 14 PM" src="https://user-images.githubusercontent.com/84657474/147347521-afcd106c-ede5-430b-81e3-72e6b802eb7e.png">
Nmap으로 포트를 확인했을때 ```22/tcp```, ```80/tcp``` 포트가 열려있는 것을 알 수 있다.

이러한 결과를 통하여 Apache httpd 2.2.21 가 - Potentially risky -HTTP Methods TRACE를 허용하는 취약점이 있다는 것을 알 수 있었다.

**** Nmap을 통하여 찾은 취약점
1. 불필요한 HTTP 메소드 허용 : TRACE
2. 웹서버 버전정보 노출 : Apache httpd 2.2.21
3. 환경설정 취약점 : 외부 SSH 접속 허용

<hr>

## Nikto를 통한 웹취약점 탐색 
80번 포트의 웹서비스를 대상으로 nikto를 실행하여 환경설정 중심의 웹 취약점을 탐색한다.
<img width="1792" alt="Screen Shot 2021-12-24 at 8 10 26 PM" src="https://user-images.githubusercontent.com/84657474/147347903-5ef35fe6-5708-44b2-a5e3-ad579fd23a2b.png">

다음과 같은 결과를 얻을 수 있었다.

**** nikto 점검 결과 의미
```+ Server: Apache/2.2.21 (Unix) DAV/2```
* Apache 2.2.21이 웹서버로 사용되고 있다.

```+ Server may leak inodes via ETags, header found with file /, inode: 4905, size: 1704, mtime: Thu Sep 25 05:56:50 2014```
* 웹 서비스를 2014년 9월 25일 작성한 것으로 추정

```+ The anti-clickjacking X-Frame-Options header is not present.```
* 클릭재킹 방어기작 부재: X-Frame-Options 참조

```+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS```
* X-XSS-Protection 참조

```+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type```
* X-Content-Type-Options 참조

```+ Apache/2.2.21 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.```
* 노후화된 Apache 웹서버 Version

```
+ Uncommon header '93e4r0-cve-2014-6278' found, with contents: true
+ OSVDB-112004: /cgi-bin/status: Site appears vulnerable to the 'shellshock' vulnerability (http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6271).
```
* 두 개의 Shellshock 취약점 탐지

```
+ Allowed HTTP Methods: GET, HEAD, POST, OPTIONS, TRACE 
+ OSVDB-877: HTTP TRACE method is active, suggesting the host is vulnerable to XST
```
* 불필요한 TRACE Methods 허용으로 XST 공격 가능성 존재

<hr>

## OWASP-ZAP을 통한 웹 어플리케이션 취약점 탐색
<img width="1792" alt="Screen Shot 2021-12-24 at 8 18 33 PM" src="https://user-images.githubusercontent.com/84657474/147348437-6353a346-03ad-4a14-87f7-cf32a47e9ee3.png">
다음과 같이 OWASP-ZAP을 통하여 취약점을 탐색한 결과 Directory Indexing 취약점이 존재한다는 것을 알 수 있었다.

<hr>

## Shellshock & CGI
GNU Bash의 Shellshock 취약점은 특수하게 조작된 환경변수를 만들 경우 환경변수 내의 문자열이 명령어로 실행되는 특수한 취약점이다.
대표적으로 현재 설명중인 CVE-2014-6271에 존재한다.

```
┌──(kali㉿kali)-[~]
└─$ export x='() { :;}; echo vulnerable' 

┌──(kali㉿kali)-[~]
└─$ bash -c "echo this is a test"
vulnerable
this is a test

┌──(kali㉿kali)-[~]
└─$ 
```

다음과 같이 환경변수에 ()가 포함된 특수한 문자열 다음에 명령어가 지정되고 이 환경변수를 받은 Bash가 실행된다면 지정된 명령어를 실행하는 특이한 취약점이다.
다만 취약점이 없다면 vulnerable이 출력되지 않는다.

<hr>

## PentesterLab CVE-2014-6271 Shellshock 진단
```+ OSVDB-112004: /cgi-bin/status: Site appears vulnerable to the 'shellshock' vulnerability (http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6278).```
CVE-2014-6271의 취약점이 /cgi-bin/status에서 탐지된것을 확인할 수 있었습니다.

HTTP 규약을 어기지 않으면서 공격자가 조작할 수 있는 HTTP 헤더는 "Agent:", "Referer:" 등이 있다.
<img width="1792" alt="Screen Shot 2021-12-24 at 8 27 35 PM" src="https://user-images.githubusercontent.com/84657474/147348999-c7330654-1912-41c6-b12e-d8b1cc2e806c.png">
<img width="1792" alt="Screen Shot 2021-12-24 at 8 27 57 PM" src="https://user-images.githubusercontent.com/84657474/147349016-33df4817-e259-49e3-9950-3e920112f789.png">

위에 두 예에서는 "Agent:"헤더를 조작하여 웹서버에 전달하였다.

첫번째에서는 명령어를 지정하지 않았고, 두번째에서는 빈줄을 출력하도록 echo 명령어를 삽입하였다.

두 결과를 비교하면 ShellShock 취약점에 의한 명령어는 헤더의 마지막 줄 앞에서 실행되어 빈 줄이 출력되는 것을 볼 수 있다.

<img width="1792" alt="Screen Shot 2021-12-24 at 8 30 52 PM" src="https://user-images.githubusercontent.com/84657474/147349213-69a78b3b-a951-4f13-974b-5fcbc01c5c59.png">
<img width="1792" alt="Screen Shot 2021-12-24 at 8 31 18 PM" src="https://user-images.githubusercontent.com/84657474/147349235-89f0e767-8f96-4843-bea8-b56262d71293.png">

다음 두개에 사진들과 같이 명령어 및 ```/etc/passwd```를 읽을 수 있는 것을 확인하였다.

악의적인 추가공격에서는 bind shell이나 reverse connection, root 권한 획득 등을 통하여 지속적인 접속을 목적으로 해당 취약점을 사용하는 것이 일반적이다.


